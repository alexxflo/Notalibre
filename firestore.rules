rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    function isChatParticipant(chatId) {
      // Allow if the user's ID is in the participantIds array of the chat document.
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
    }

    // USER PROFILES
    // Path: /users/{userId}
    match /users/{userId} {
      // Anyone can read any user profile.
      allow read: if true;
      
      // Only the owner can create their own profile.
      allow create: if isOwner(userId);
      
      // Any signed-in user can update any profile.
      // This is necessary for the "follow/unfollow" feature, where user A
      // needs to update user B's 'followers' array.
      allow update: if isSignedIn();

      // Only the owner can delete their profile.
      allow delete: if isOwner(userId);

      // USER NOTIFICATIONS (Sub-collection)
      // Path: /users/{userId}/notifications/{notificationId}
      match /notifications/{notificationId} {
        // Any signed-in user can create a notification for another user (e.g., for follows, likes).
        allow create: if isSignedIn();
        // Only the owner of the notifications can read, update, or delete them.
        allow read, update, delete: if isOwner(userId);
      }
      
      // SUPPORT CHAT MESSAGES (Sub-collection)
      // Path: /users/{userId}/messages/{messageId}
      match /messages/{messageId} {
        // Only the owner can read and write their own private support messages.
        allow read, write: if isOwner(userId);
      }
    }

    // POSTS
    // Path: /posts/{postId}
    match /posts/{postId} {
      // Anyone can read posts.
      allow read: if true;
      // Any signed-in user can create, update, or delete posts.
      // For more security, update/delete should be restricted to the post owner.
      allow write: if isSignedIn();

      // POST COMMENTS (Sub-collection)
      // Path: /posts/{postId}/comments/{commentId}
      match /comments/{commentId} {
        // Anyone can read comments.
        allow read: if true;
        // Any signed-in user can write comments.
        allow write: if isSignedIn();
      }
    }

    // PRIVATE CHATS
    // Path: /chats/{chatId}
    match /chats/{chatId} {
      // Only a participant can get the specific chat document.
      allow get: if isChatParticipant(chatId);

      // A signed-in user can query the list of chats.
      // The client-side query MUST filter this list to only the user's chats.
      // e.g., where('participantIds', 'array-contains', request.auth.uid)
      allow list: if isSignedIn();

      // Any signed-in user can create a new chat, as long as they include themselves.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantIds;
      
      // Only participants can update chat metadata (e.g., lastMessage).
      allow update: if isChatParticipant(chatId);

      // MESSAGES (Sub-collection)
      // Path: /chats/{chatId}/messages/{messageId}
      match /messages/{messageId} {
        // Only a participant of the parent chat can read or write messages in it.
        allow read, write: if isChatParticipant(chatId);
      }
    }

    // Other collections (currently open for any authenticated user)
    match /campaigns/{campaignId} {
      allow read, write: if isSignedIn();
    }
    match /purchase_verifications/{verificationId} {
      allow read, write: if isSignedIn();
    }
    match /stats/{docId=**} {
      allow read, write: if isSignedIn();
    }
  }
}
