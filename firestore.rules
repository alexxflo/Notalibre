rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // PERFIL DE USUARIO Y SUS SUB-COLECCIONES
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // MENSAJES DE SOPORTE: Solo el dueño del perfil puede leer/escribir.
      match /messages/{messageId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // NOTIFICACIONES: El dueño puede leer/actualizar/borrar, y cualquiera puede crearlas si son el actor.
      match /notifications/{notificationId} {
        allow read, update, delete: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == request.resource.data.actorId;
      }
    }

    // REGLAS PARA CHATS GLOBALES
    match /chats/{chatId} {
      // PERMITIR CONSULTAS (LIST):
      // Necesario para buscar tus propios chats. La consulta en el cliente SIEMPRE debe
      // incluir `where('participantIds', 'array-contains', request.auth.uid)`.
      allow list: if request.auth != null;
      
      // PERMITIR LEER UN DOCUMENTO (GET):
      // Esencial para comprobar si un chat ya existe con `getDoc()`.
      // La seguridad se basa en que el ID del chat contiene el UID del usuario.
      allow get: if request.auth != null && chatId.matches(request.auth.uid);
      
      // PERMITIR ACTUALIZAR (UPDATE):
      // Para actualizar `lastMessage`. La regla verifica que el usuario es un participante
      // real leyendo el contenido del documento que se va a actualizar.
      allow update: if request.auth != null && 
        request.auth.uid in resource.data.participantIds;
      
      // PERMITIR CREAR (CREATE):
      // Permite la creación del chat si el usuario se incluye a sí mismo.
      // `request.resource.data` se refiere a los datos del documento que se está creando.
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participantIds;

      // REGLAS PARA MENSAJES DENTRO DEL CHAT
      match /messages/{messageId} {
        // Solo se puede leer o escribir si eres participante del chat padre.
        // `get()` realiza una lectura del documento del chat, lo cual tiene un costo en el plan de Firebase.
        allow read, write: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
      }
    }

    // REGLA PARA POSTS
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && 
        (resource.data.authorId == request.auth.uid || resource.data.userId == request.auth.uid);
    }

    // REGLAS PARA CAMPAÑAS
    match /campaigns/{campaignId} {
      // Cualquiera puede leer la lista de campañas para participar
      allow read: if request.auth != null;

      // Cualquiera puede crear una campaña (la lógica de costo está en el cliente)
      allow create: if request.auth != null;

      // Cualquiera puede borrar una campaña para "reclamarla".
      allow delete: if request.auth != null;
    }

    // REGLAS PARA ESTADÍSTICAS
    match /stats/{statId} {
      allow read: if request.auth != null;
    }
  }
}
